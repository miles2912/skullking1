<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skull King Scorekeeper</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for the player selection buttons */
        .player-btn {
            border: 2px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .player-btn.selected {
            background-color: #fca5a5; /* Red-300 */
            color: #1f2937; /* Gray-800 */
            border-color: #ef4444; /* Red-500 */
            transform: scale(1.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Hide the number input arrows/spinners for all browsers */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
        }
        .message-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            background-color: #ef4444;
            color: white;
            font-weight: bold;
            border-radius: 9999px; /* rounded-full */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 1000;
            display: none;
            animation: fadeInOut 4s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            90% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(5px);
        }
        /* New flashing animation for the winner's score */
        @keyframes flash-winner {
            0%, 100% { box-shadow: 0 0 0px 0px rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 10px 5px rgba(239, 68, 68, 0.7); }
        }
        .winner-score-flash {
            animation: flash-winner 2s ease-in-out infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col items-center justify-start p-4 pt-12">

    <!-- Message Box for user feedback -->
    <div id="message-box" class="message-box"></div>

    <!-- Main container for the app -->
    <div id="setup-screen" class="bg-gray-800 p-8 md:p-12 rounded-3xl shadow-2xl border border-gray-700 w-full max-w-2xl text-center transition-all duration-300 transform scale-100 relative">
        
        <!-- Main title -->
        <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-6">Welcome to Skull King Scoring</h1>

        <!-- Player count selection -->
        <p class="text-lg md:text-xl text-gray-300 mb-8">How many players are playing?</p>
        
        <!-- Player count buttons -->
        <div class="flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-4 mb-4">
            <button id="three-players-btn" class="px-6 py-3 bg-red-600 text-white font-bold rounded-full shadow-lg hover:bg-red-700 transition duration-300 transform hover:scale-105 active:scale-95">
                3 Players
            </button>
            <button id="four-players-btn" class="px-6 py-3 bg-red-600 text-white font-bold rounded-full shadow-lg hover:bg-red-700 transition duration-300 transform hover:scale-105 active:scale-95">
                4 Players
            </button>
        </div>
        
        <!-- New Help button, centered below the player count buttons -->
        <div id="help-button-container" class="flex justify-center">
            <button id="help-btn" class="px-6 py-3 bg-yellow-400 text-gray-900 font-bold rounded-full shadow-lg hover:bg-yellow-500 transition duration-300 transform hover:scale-105 active:scale-95">
                Help for Noobs
            </button>
        </div>
        
        <!-- Player name selection section -->
        <div id="player-selection-section" class="hidden mt-8 text-left">
            <h2 class="text-2xl md:text-3xl font-bold text-white mb-4 text-center">Select Players</h2>
            
            <!-- Message to guide the user on player selection -->
            <p id="selection-message" class="text-center text-gray-400 mb-6"></p>

            <div id="player-buttons-container" class="grid grid-cols-2 gap-4">
                <!-- Player buttons will be dynamically inserted here -->
            </div>
            
            <button id="start-game-btn" class="mt-8 w-full px-6 py-3 bg-green-600 text-white font-bold rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 active:scale-95 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                Start Game!
            </button>
        </div>
    </div>
    
    <!-- Game screen (initially hidden) -->
    <div id="game-screen" class="hidden bg-gray-800 p-8 md:p-12 rounded-3xl shadow-2xl border border-gray-700 w-full max-w-4xl text-center relative flex flex-col items-center">
        <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-4">Skull King Scoring</h1>
        <h2 id="round-title" class="text-2xl md:text-3xl font-bold text-red-400 mb-6">Round 1 (1 Card)</h2>
        
        <div id="round-table-container" class="w-full overflow-x-auto">
            <table class="min-w-full bg-gray-900 rounded-lg shadow-inner">
                <thead>
                    <tr>
                        <th class="px-4 py-2 border-b-2 border-gray-700 text-left text-sm leading-4 font-medium text-gray-400 uppercase tracking-wider">Player</th>
                        <th class="px-4 py-2 border-b-2 border-gray-700 text-center text-sm leading-4 font-medium text-gray-400 uppercase tracking-wider">Bid</th>
                        <th class="px-4 py-2 border-b-2 border-gray-700 text-center text-sm leading-4 font-medium text-gray-400 uppercase tracking-wider">Tricks Won</th>
                        <th class="px-4 py-2 border-b-2 border-gray-700 text-center text-sm leading-4 font-medium text-gray-400 uppercase tracking-wider">Bonus</th>
                        <th class="px-4 py-2 border-b-2 border-gray-700 text-center text-sm leading-4 font-medium text-gray-400 uppercase tracking-wider">Score</th>
                        <th class="px-4 py-2 border-b-2 border-gray-700 text-center text-sm leading-4 font-medium text-gray-400 uppercase tracking-wider">Total</th>
                    </tr>
                </thead>
                <tbody id="score-table-body">
                    <!-- Player rows will be dynamically inserted here -->
                </tbody>
            </table>
        </div>

        <!-- Summary Table (initially hidden) -->
        <div id="summary-table-container" class="hidden w-full overflow-x-auto">
            <table class="min-w-full bg-gray-900 rounded-lg shadow-inner">
                <thead id="summary-table-head">
                    <!-- Summary table header will be dynamically inserted here -->
                </thead>
                <tbody id="summary-table-body">
                    <!-- Summary table rows will be dynamically inserted here -->
                </tbody>
            </table>
        </div>

        <div id="game-buttons" class="mt-8 flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-4 w-full">
            <button id="previous-round-btn" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-full shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105 active:scale-95 hidden">
                Previous Round
            </button>
            <button id="next-round-btn" class="px-6 py-3 bg-green-600 text-white font-bold rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 active:scale-95">
                Next Round
            </button>
            <button id="new-game-btn" class="px-6 py-3 bg-red-600 text-white font-bold rounded-full shadow-lg hover:bg-red-700 transition duration-300 transform hover:scale-105 active:scale-95 hidden">
                New Game
            </button>
        </div>
    </div>

    <!-- Help Modal (new) -->
    <div id="help-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal p-4">
        <div class="bg-gray-800 p-6 md:p-8 rounded-3xl shadow-2xl border border-gray-700 w-full max-w-2xl text-center flex flex-col">
            <div class="flex-grow overflow-y-auto pr-2">
                <h3 class="text-xl md:text-2xl font-bold text-white mb-4">Quick Bonus Guide</h3>
                <p class="text-gray-300 text-left mb-8">
                    If a player's bid is correct, they can score bonus points by collecting special cards:
                </p>
                <ul class="text-gray-300 text-left list-disc list-inside mb-8 space-y-2">
                    <li>
                        +10 points for capturing a Jolly Roger card (the one with the '14' on it).
                    </li>
                    <li>
                        +20 points for a Pirate capturing a Mermaid.
                    </li>
                    <li>
                        +30 points for the Skull King capturing a Pirate.
                    </li>
                    <li>
                        +40 points for a Mermaid capturing the Skull King.
                    </li>
                </ul>
            </div>
            <button id="back-to-game-btn" class="mt-6 px-6 py-3 bg-red-600 text-white font-bold rounded-full shadow-lg hover:bg-red-700 transition duration-300 transform hover:scale-105 active:scale-95">
                Back to Game
            </button>
        </div>
    </div>
    
    <!-- Kraken Modal (initially hidden) -->
    <div id="kraken-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal p-4">
        <div class="bg-gray-800 p-6 md:p-8 rounded-3xl shadow-2xl border border-gray-700 w-full max-w-sm text-center">
            <img src="https://placehold.co/150x150/0f172a/fca5a5?text=Kraken" alt="Kraken" class="mx-auto mb-4 rounded-xl">
            <p class="text-gray-300 mb-6">The total number of tricks won does not match the number of cards this round. This can happen when a Kraken is played.</p>
            <div class="flex justify-center space-x-4">
                <button id="kraken-yes-btn" class="px-6 py-3 bg-green-600 text-white font-bold rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 active:scale-95">
                    Yes
                </button>
                <button id="kraken-no-btn" class="px-6 py-3 bg-red-600 text-white font-bold rounded-full shadow-lg hover:bg-red-700 transition duration-300 transform hover:scale-105 active:scale-95">
                    No, go back
                </button>
            </div>
        </div>
    </div>
    
    <!-- Load Game Modal (new modal for local storage) -->
    <div id="load-game-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal p-4">
        <div class="bg-gray-800 p-6 md:p-8 rounded-3xl shadow-2xl border border-gray-700 w-full max-w-sm text-center">
            <h3 class="text-2xl font-bold text-white mb-4">Resume Game?</h3>
            <p class="text-gray-300 mb-6">It looks like you have a game in progress. Would you like to continue from round <span id="saved-round-number" class="font-bold"></span>?</p>
            <div class="flex flex-col space-y-4">
                <button id="resume-game-btn" class="px-6 py-3 bg-green-600 text-white font-bold rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 active:scale-95">
                    Resume Game
                </button>
                <button id="new-game-from-modal-btn" class="px-6 py-3 bg-red-600 text-white font-bold rounded-full shadow-lg hover:bg-red-700 transition duration-300 transform hover:scale-105 active:scale-95">
                    Start New Game
                </button>
            </div>
        </div>
    </div>


    <script>
        // Define the static player names
        const ALL_PLAYER_NAMES = ['Jason', 'Don', 'Les', 'Rich'];
        const GAME_SAVE_KEY = 'skullKingGameState';

        // Get references to the HTML elements
        const setupScreen = document.getElementById('setup-screen');
        const gameScreen = document.getElementById('game-screen');
        const threePlayersBtn = document.getElementById('three-players-btn');
        const fourPlayersBtn = document.getElementById('four-players-btn');
        const helpBtn = document.getElementById('help-btn');
        const helpButtonContainer = document.getElementById('help-button-container');
        const playerSelectionSection = document.getElementById('player-selection-section');
        const playerButtonsContainer = document.getElementById('player-buttons-container');
        const selectionMessage = document.getElementById('selection-message');
        const startGameBtn = document.getElementById('start-game-btn');
        const roundTitle = document.getElementById('round-title');
        const roundTableContainer = document.getElementById('round-table-container');
        const scoreTableBody = document.getElementById('score-table-body');
        const summaryTableContainer = document.getElementById('summary-table-container');
        const summaryTableHead = document.getElementById('summary-table-head');
        const summaryTableBody = document.getElementById('summary-table-body');
        const previousRoundBtn = document.getElementById('previous-round-btn');
        const nextRoundBtn = document.getElementById('next-round-btn');
        const newGameBtn = document.getElementById('new-game-btn');
        const messageBox = document.getElementById('message-box');

        // Help modal elements
        const helpModal = document.getElementById('help-modal');
        const backToGameBtn = document.getElementById('back-to-game-btn');
        
        // Kraken modal elements
        const krakenModal = document.getElementById('kraken-modal');
        const krakenYesBtn = document.getElementById('kraken-yes-btn');
        const krakenNoBtn = document.getElementById('kraken-no-btn');

        // Load Game modal elements
        const loadGameModal = document.getElementById('load-game-modal');
        const savedRoundNumberSpan = document.getElementById('saved-round-number');
        const resumeGameBtn = document.getElementById('resume-game-btn');
        const newGameFromModalBtn = document.getElementById('new-game-from-modal-btn');

        let playerCount = 0;
        let selectedPlayers = [];
        let gameData = [];
        let currentRound = 1;

        // Function to display a temporary message to the user
        function showMessage(message) {
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 4000);
        }

        // --- LOCAL STORAGE FUNCTIONS ---
        // Function to save the current game state to local storage
        function saveGameState() {
            const state = {
                gameData: gameData,
                selectedPlayers: selectedPlayers,
                playerCount: playerCount,
                currentRound: currentRound
            };
            localStorage.setItem(GAME_SAVE_KEY, JSON.stringify(state));
        }

        // Function to load the game state from local storage
        function loadGameState() {
            const savedState = localStorage.getItem(GAME_SAVE_KEY);
            if (savedState) {
                const state = JSON.parse(savedState);
                gameData = state.gameData;
                selectedPlayers = state.selectedPlayers;
                playerCount = state.playerCount;
                currentRound = state.currentRound;
                return true;
            }
            return false;
        }

        // Function to clear the saved game state from local storage
        function clearSavedGame() {
            localStorage.removeItem(GAME_SAVE_KEY);
        }
        
        // Function to start a new game by clearing local storage and reloading
        function restartGame() {
            clearSavedGame();
            location.reload();
        }

        // Function to render the player name buttons on the setup screen
        function renderPlayerButtons() {
            playerButtonsContainer.innerHTML = '';
            ALL_PLAYER_NAMES.forEach(name => {
                const button = document.createElement('button');
                button.textContent = name;
                button.classList.add(
                    'player-btn', 
                    'px-6', 'py-4', 
                    'bg-gray-700', 
                    'text-lg', 'text-white', 
                    'font-semibold', 
                    'rounded-xl', 
                    'shadow', 
                    'hover:bg-gray-600', 
                    'focus:outline-none', 
                    'focus:ring-2', 
                    'focus:ring-red-500'
                );
                
                if (selectedPlayers.includes(name)) {
                    button.classList.add('selected');
                }

                button.addEventListener('click', () => {
                    togglePlayerSelection(name);
                });

                playerButtonsContainer.appendChild(button);
            });
        }

        // Function to update the selection message and button state
        function updateSetupUI() {
            const numSelected = selectedPlayers.length;
            selectionMessage.textContent = `Selected players: ${numSelected} of ${playerCount}`;

            if (numSelected === playerCount) {
                startGameBtn.disabled = false;
            } else {
                startGameBtn.disabled = true;
            }
        }

        // Function to handle player button clicks (select/deselect)
        function togglePlayerSelection(name) {
            const index = selectedPlayers.indexOf(name);
            if (index > -1) {
                selectedPlayers.splice(index, 1);
            } else {
                if (selectedPlayers.length < playerCount) {
                    selectedPlayers.push(name);
                } else {
                    showMessage(`Cannot select more than ${playerCount} players.`);
                    return;
                }
            }
            renderPlayerButtons();
            updateSetupUI();
        }

        // Scoring Logic Function
        function calculateRoundScore(bid, tricksWon, bonus, round) {
            let score = 0;
            // Handle null bids/tricks by treating them as 0 for scoring
            const effectiveBid = bid === null ? 0 : bid;
            const effectiveTricksWon = tricksWon === null ? 0 : tricksWon;

            if (effectiveBid == effectiveTricksWon) {
                // Correct bid
                if (effectiveBid === 0) {
                    score = round * 10;
                } else {
                    score = effectiveBid * 20;
                }
                // Add bonus points if the bid was correct and a bonus was entered
                if (bonus !== null) {
                    score += bonus;
                }
            } else {
                // Incorrect bid
                if (effectiveBid === 0) {
                    score = effectiveTricksWon * -10;
                } else {
                    score = Math.abs(effectiveTricksWon - effectiveBid) * -10;
                }
            }
            return score;
        }

        // Function to recalculate total scores for all players up to the current round
        function recalculateTotalScores() {
            selectedPlayers.forEach((player, index) => {
                let total = 0;
                for (let i = 0; i < 10; i++) {
                    // Only add score if the round has been played
                    if (gameData[index].roundScores[i] !== null) {
                        total += gameData[index].roundScores[i];
                    }
                }
                gameData[index].totalScore = total;
            });
        }

        // Function to render the final game summary table
        function renderSummaryTable() {
            // Hide the round-by-round table and show the summary table
            roundTableContainer.classList.add('hidden');
            summaryTableContainer.classList.remove('hidden');

            // Update title and buttons for the end of the game
            roundTitle.textContent = "Final Scores";
            previousRoundBtn.classList.add('hidden');
            nextRoundBtn.classList.add('hidden');
            newGameBtn.classList.remove('hidden');
            newGameBtn.textContent = "Start New Game";
            
            // Clear previous table content
            summaryTableHead.innerHTML = '';
            summaryTableBody.innerHTML = '';
            
            // Create table header
            const headerRow = document.createElement('tr');
            let headerHtml = `<th class="px-4 py-2 border-b-2 border-gray-700 text-left text-sm leading-4 font-medium text-gray-400 uppercase tracking-wider">Player</th>`;
            for (let i = 1; i <= 10; i++) {
                headerHtml += `<th class="px-2 py-2 border-b-2 border-gray-700 text-center text-sm leading-4 font-medium text-gray-400 uppercase tracking-wider">R${i} Bid/Tricks</th>`;
            }
            headerHtml += `<th class="px-4 py-2 border-b-2 border-gray-700 text-center text-sm leading-4 font-medium text-gray-400 uppercase tracking-wider">Final Score</th>`;
            headerRow.innerHTML = headerHtml;
            summaryTableHead.appendChild(headerRow);

            // Find the highest score to determine the winner(s)
            let maxScore = -Infinity;
            gameData.forEach(player => {
                if (player.totalScore > maxScore) {
                    maxScore = player.totalScore;
                }
            });

            // Populate the table with final game data
            gameData.forEach(player => {
                const tr = document.createElement('tr');
                tr.classList.add('border-b', 'border-gray-700', 'hover:bg-gray-600', 'transition-colors');
                const isWinner = player.totalScore === maxScore;

                // Player name cell
                let rowHtml = `<td class="px-4 py-4 whitespace-nowrap text-left font-medium text-white">${player.name}</td>`;
                
                // Bid/Tricks for each round
                for (let i = 0; i < 10; i++) {
                    const bid = player.bids[i] !== null ? player.bids[i] : '-';
                    const tricks = player.tricksWon[i] !== null ? player.tricksWon[i] : '-';
                    rowHtml += `<td class="px-2 py-4 text-center text-white">${bid}/${tricks}</td>`;
                }

                // Final Score cell with conditional flashing class
                const winnerClass = isWinner ? 'winner-score-flash' : '';
                rowHtml += `<td class="px-4 py-4 text-center">
                                <span class="bg-red-600 text-white font-bold px-3 py-1 rounded-full inline-block min-w-[48px] text-center shadow-md ${winnerClass}">
                                    ${player.totalScore}
                                </span>
                            </td>`;
                
                tr.innerHTML = rowHtml;
                summaryTableBody.appendChild(tr);
            });
        }

        // Function to update the gameData with current table input values
        function updateGameDataFromTable() {
            selectedPlayers.forEach((playerName, index) => {
                const bidInput = document.getElementById(`bid-${index}`);
                const tricksInput = document.getElementById(`tricks-${index}`);
                const bonusInput = document.getElementById(`bonus-${index}`);
                
                // Convert empty strings to null for saving, and 0 for scoring calculations
                const bidValue = bidInput.value.trim() === '' ? null : parseInt(bidInput.value, 10);
                const tricksValue = tricksInput.value.trim() === '' ? null : parseInt(tricksInput.value, 10);
                const bonusValue = bonusInput.value.trim() === '' ? null : parseInt(bonusInput.value, 10);

                gameData[index].bids[currentRound - 1] = bidValue;
                gameData[index].tricksWon[currentRound - 1] = tricksValue;
                gameData[index].bonuses[currentRound - 1] = bonusValue;

                // Re-calculate the score for the current round with the new values
                const roundScore = calculateRoundScore(bidValue, tricksValue, bonusValue, currentRound);
                gameData[index].roundScores[currentRound - 1] = roundScore;
            });
            recalculateTotalScores();
            saveGameState();
        }
        
        // Function to render the game scoring table
        function renderScoreTable() {
            if (currentRound > 10) {
                renderSummaryTable();
                return;
            }

            // Hide the summary table and show the round-by-round table
            summaryTableContainer.classList.add('hidden');
            roundTableContainer.classList.remove('hidden');

            scoreTableBody.innerHTML = ''; // Clear table
            roundTitle.textContent = `Round ${currentRound} (${currentRound} Card${currentRound > 1 ? 's' : ''})`;

            // Show or hide the "Previous Round" button
            if (currentRound > 1) {
                previousRoundBtn.classList.remove('hidden');
            } else {
                previousRoundBtn.classList.add('hidden');
            }
            
            // On round 10, change the button text to "Show Final Scores"
            if (currentRound === 10) {
                nextRoundBtn.textContent = "Show Final Scores";
            } else {
                nextRoundBtn.textContent = "Next Round";
            }
            nextRoundBtn.classList.remove('hidden');
            newGameBtn.classList.add('hidden');

            selectedPlayers.forEach((playerName, index) => {
                const tr = document.createElement('tr');
                tr.classList.add('border-b', 'border-gray-700', 'hover:bg-gray-600', 'transition-colors');

                // Player Name Cell
                const nameCell = document.createElement('td');
                nameCell.textContent = playerName;
                nameCell.classList.add('px-4', 'py-4', 'whitespace-nowrap', 'text-left', 'font-medium', 'text-white');
                tr.appendChild(nameCell);

                // Bid Input Cell
                const bidCell = document.createElement('td');
                const bidInput = document.createElement('input');
                bidInput.type = 'number';
                const bidValue = gameData[index].bids[currentRound - 1];
                // Display empty string to allow for "null" input
                bidInput.value = bidValue !== null ? bidValue : '';
                bidInput.min = 0;
                bidInput.max = currentRound;
                bidInput.id = `bid-${index}`;
                bidInput.classList.add('w-20', 'bg-gray-700', 'text-white', 'rounded-md', 'px-2', 'py-1', 'text-center', 'focus:outline-none', 'focus:ring-2', 'focus:ring-red-400', 'focus:bg-gray-600');
                bidCell.classList.add('px-4', 'py-4', 'text-center');
                bidCell.appendChild(bidInput);
                tr.appendChild(bidCell);

                // Tricks Won Input Cell
                const tricksWonCell = document.createElement('td');
                const tricksInput = document.createElement('input');
                tricksInput.type = 'number';
                const tricksValue = gameData[index].tricksWon[currentRound - 1];
                tricksInput.value = tricksValue !== null ? tricksValue : '';
                tricksInput.min = 0;
                tricksInput.max = currentRound;
                tricksInput.id = `tricks-${index}`;
                tricksInput.classList.add('w-20', 'bg-gray-700', 'text-white', 'rounded-md', 'px-2', 'py-1', 'text-center', 'focus:outline-none', 'focus:ring-2', 'focus:ring-red-400', 'focus:bg-gray-600');
                tricksWonCell.classList.add('px-4', 'py-4', 'text-center');
                tricksWonCell.appendChild(tricksInput);
                tr.appendChild(tricksWonCell);

                // Bonus Input Cell (manually editable)
                const bonusCell = document.createElement('td');
                const bonusInput = document.createElement('input');
                bonusInput.type = 'number';
                const bonusValue = gameData[index].bonuses[currentRound - 1];
                bonusInput.value = bonusValue !== null ? bonusValue : '';
                bonusInput.min = 0;
                bonusInput.id = `bonus-${index}`;
                bonusInput.classList.add(
                    'w-20', 'bg-gray-700', 'text-white', 'rounded-md', 'px-2', 'py-1', 'text-center', 
                    'focus:outline-none', 'focus:ring-2', 'focus:ring-red-400', 'focus:bg-gray-600'
                );
                bonusCell.classList.add('px-4', 'py-4', 'text-center');
                bonusCell.appendChild(bonusInput);
                tr.appendChild(bonusCell);

                // Round Score Cell
                const roundScoreCell = document.createElement('td');
                const roundScoreValue = gameData[index].roundScores[currentRound - 1];
                roundScoreCell.textContent = roundScoreValue !== null ? roundScoreValue : '';
                roundScoreCell.classList.add('px-4', 'py-4', 'text-center', 'text-white', 'font-bold');
                tr.appendChild(roundScoreCell);
                
                // Total Score Cell
                const totalScoreCell = document.createElement('td');
                const totalScoreSpan = document.createElement('span');
                totalScoreSpan.textContent = gameData[index].totalScore;
                totalScoreSpan.classList.add('bg-red-600', 'text-white', 'font-bold', 'px-3', 'py-1', 'rounded-full', 'inline-block', 'min-w-[48px]', 'text-center', 'shadow-md');
                totalScoreCell.classList.add('px-4', 'py-4', 'text-center');
                totalScoreCell.appendChild(totalScoreSpan);
                tr.appendChild(totalScoreCell);

                scoreTableBody.appendChild(tr);
            });
        }
        
        // Function to process the scores and advance to the next round
        function processNextRound() {
            // Update game data from the table one last time
            updateGameDataFromTable();
            
            // Recalculate all total scores after a round is complete
            recalculateTotalScores();
            
            currentRound++; // Move to the next round
            renderScoreTable(); // Re-render the table with new data
            saveGameState(); // Save the new state
        }

        // Kraken modal button listeners
        krakenYesBtn.addEventListener('click', () => {
            krakenModal.classList.add('hidden');
            processNextRound();
        });

        krakenNoBtn.addEventListener('click', () => {
            krakenModal.classList.add('hidden');
            // Do nothing, user can now edit the values
        });

        // Handle the "Next Round" button click
        nextRoundBtn.addEventListener('click', () => {
            updateGameDataFromTable(); // Ensure data is saved before validation
            let totalTricks = 0;
            let isValid = true;

            for (let i = 0; i < playerCount; i++) {
                const bid = gameData[i].bids[currentRound - 1];
                const tricks = gameData[i].tricksWon[currentRound - 1];

                // The bug fix is here: we now check for null, but process it as a valid 0
                const effectiveBid = bid === null ? 0 : bid;
                const effectiveTricks = tricks === null ? 0 : tricks;

                // Check for valid number inputs
                if (isNaN(effectiveBid) || isNaN(effectiveTricks) || (effectiveBid > currentRound || effectiveBid < 0) || (effectiveTricks > currentRound || effectiveTricks < 0)) {
                    isValid = false;
                    break;
                }
                
                totalTricks += effectiveTricks;
            }
            
            if (!isValid) {
                showMessage("Invalid input. Please check bids and tricks won values.");
                return;
            }
            
            if (totalTricks !== currentRound) {
                krakenModal.classList.remove('hidden');
            } else {
                processNextRound();
            }
        });

        // Event listener for the "Previous Round" button
        previousRoundBtn.addEventListener('click', () => {
            if (currentRound > 1) {
                // BUG FIX: Removed the call to updateGameDataFromTable() here.
                // The "Next Round" button is now the designated "save" action.
                // This prevents unsaved data for the current round from overwriting itself
                // with empty values when you go back.
                currentRound--;
                renderScoreTable();
                saveGameState(); // Save the state after the round change
            }
        });

        // Event listener for the "New Game" button
        newGameBtn.addEventListener('click', () => {
            restartGame();
        });


        // Handle player count button clicks
        threePlayersBtn.addEventListener('click', () => {
            playerCount = 3;
            selectedPlayers = [];
            playerSelectionSection.classList.remove('hidden');
            helpButtonContainer.classList.add('hidden'); // Hide the help button container
            renderPlayerButtons();
            updateSetupUI();
        });

        fourPlayersBtn.addEventListener('click', () => {
            playerCount = 4;
            selectedPlayers = [...ALL_PLAYER_NAMES];
            playerSelectionSection.classList.remove('hidden');
            helpButtonContainer.classList.add('hidden'); // Hide the help button container
            renderPlayerButtons();
            updateSetupUI();
        });

        // Handle the "Start Game" button click
        startGameBtn.addEventListener('click', (event) => {
            event.preventDefault(); // Prevent form submission
            
            // Initialize game data for each player
            gameData = selectedPlayers.map(name => ({
                name: name,
                bids: new Array(10).fill(null),
                tricksWon: new Array(10).fill(null),
                bonuses: new Array(10).fill(null),
                roundScores: new Array(10).fill(null),
                totalScore: 0
            }));

            // Hide the setup screen and show the game screen
            setupScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');

            // Render the initial score table
            renderScoreTable();
            saveGameState();
        });

        // Event listener for the new "Help for Noobs" button
        helpBtn.addEventListener('click', () => {
            setupScreen.classList.add('hidden');
            helpModal.classList.remove('hidden');
        });

        // Event listener for the "Back to Game" button in the help modal
        backToGameBtn.addEventListener('click', () => {
            helpModal.classList.add('hidden');
            setupScreen.classList.remove('hidden');
        });

        // Load Game modal button listeners
        resumeGameBtn.addEventListener('click', () => {
            if (loadGameState()) {
                loadGameModal.classList.add('hidden');
                setupScreen.classList.add('hidden');
                gameScreen.classList.remove('hidden');
                renderScoreTable();
            } else {
                showMessage("Could not load saved game data.");
                loadGameModal.classList.add('hidden');
                setupScreen.classList.remove('hidden');
            }
        });

        newGameFromModalBtn.addEventListener('click', () => {
            restartGame();
        });


        // --- INITIALIZATION ---
        // On page load, check for a saved game
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem(GAME_SAVE_KEY)) {
                // If a saved game exists, show the load game modal
                const savedState = JSON.parse(localStorage.getItem(GAME_SAVE_KEY));
                savedRoundNumberSpan.textContent = savedState.currentRound;
                loadGameModal.classList.remove('hidden');
                // The help button will be hidden by this logic if they resume a game
                helpButtonContainer.classList.add('hidden');
            } else {
                // Otherwise, show the normal setup screen and ensure help button is visible
                setupScreen.classList.remove('hidden');
                helpButtonContainer.classList.remove('hidden');
            }
        });
    </script>
    
    <!-- Footer with production credit and version number -->
    <div class="fixed bottom-4 right-4 text-gray-500 text-sm z-50">
        Designed by DW Productions
        <span class="text-xs text-gray-600">v0.8</span>
    </div>

</body>
</html>
